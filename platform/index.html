<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Autolayout for Web Development</title>
    <style>
    body {
        margin: 0;
        display: flex;
        flex-direction: column;
        min-height: 100vh;
        z-index: 0;
    }
    
    .header {
        flex: 0 0 30px;
        border: solid 1px #aaa;
        border-width: 0 0 1px 0;
        background: #e6e6e6;
        z-index: 99999;
        box-shadow: 0 0 20px #777;
    }
    
    .logo {
        display: inline-block;
        height: 30px;
        width: 30px;
        background: url(image/autolayout.png);
        background-size: 30px;
        background-repeat: no-repeat;
        margin: -8px 35px;
    }
    
    .action-bar {
        height: 24px;
        line-height: 24px;
        margin: 3px 0;
        padding: 0;
        display: inline-block;
    }
    
    .action-bar li {
        display: inline-block;
        box-sizing: border-box;
        border: 1px solid #d6d6d6;
        border-radius: 4px;
        padding: 0 5px;
        cursor: pointer;
        background: repeating-linear-gradient(#fff, #f9f9f9 5%, #e6e6e6 30%, #d6d6d6 100%)
    }
    
    .action-bar li:hover {
        box-shadow: 1px 1px 1px #798;
    }
    
    .container {
        display: flex;
        flex: 1 1 auto;
        background: #c9c9c9;
        min-width: 600px;
        z-index: 0;
    }
    
    .navigation-bar {
        overflow: auto;
        resize: horizontal;
        /*order: 1;*/
        width: 150px;
        z-index: 99999;
        background: #e6e6e6;
        box-shadow: 0 0 20px #777;
    }
    .navigation-head{
        height: 25px;
        margin: 10px 0 0 0;
        width: 100%;
        background: #c9c9c9;
        /*text-align: center;*/
        font-size: 15px;
        line-height: 25px;
    }
    .layer-item{
        height: 50px;
        width: 100%;
        margin: 1px 0;
        background: #fff;
    }
    .layer-selected{
        background: #03a9f4;
    }
    .canvas {
        order: 2;
        flex: 1 1 auto;
        position: relative;
        z-index: 0;
        overflow: hidden;
    }
    .scale-bar{
        position: absolute;
        left: 50px;
        bottom: 50px;
        -webkit-user-select:none;
        height: 30px;
        width: 140px;
        z-index: 99999;
    }
    .scale-small,.scale-status,.scale-large{
        font-family: "微软雅黑";
        font-size: 15px;
        display: inline-block;
        -webkit-user-select:none;
        width: 30px;
        height: 25px;
        box-sizing: border-box;
    }
    .scale-status{
        text-align: center;
        vertical-align: middle;
    }
    
    .tools-bar {
        order: 3;
        flex: 0 0 270px;
        z-index: 99999;
        background: #e6e6e6;
        box-shadow: 0 0 20px #777;
    }
    
    .tools-module {
        height: 200px;
        width: 100%;
        /*background: #798;*/
        border: 1px solid #9c9c9c;
        box-sizing: border-box;
        padding: 5px;
    }
    
    .module {
        position: absolute;
        border-radius: 5px;
        width: 50px;
        height: 50px;
        cursor: pointer;
    }
    .module-symbol{
        border: 1px solid #c5c5c5;
        border-radius: 5px;
        margin: 5px;
        float: left;
        background: #f9f9f9;
        width: 50px;
        height: 50px;
        cursor: pointer;
    }
    .module-lable {
        background: #798;
    }
    
    .module-image {
        background: #473;
    }
    
    .module-button {
        background: blue;
    }
    .module-view{
        background: red;
    }
    .attributes-editor{
        border: 1px solid #9c9c9c;
        box-sizing: border-box;
        padding: 5px;
    }
    .attribute-warp{
        text-align: right;
        margin: 10px auto;
        width: 230px;
    }
    .attribute-warp input{
        width: 130px;
    }
    .footer {
        flex: 0 0 5vh;
        border: solid 1px #aaa;
        border-width: 1px 0 0 0;
        background: #e6e6e6;
        z-index: 99999;
        box-shadow: 0 0 20px #777;
    }
    
    .screen {
        position: absolute;
        top: 50px;
        left: 50px;
        box-shadow: 0 0 10px #777;
        z-index: 1;
        zoom :1;
    }
    
    .w414-h736 {
        height: 736px;
        width: 414px;
        background: #fff;
    }
    .test{
        width: 30px;
        height: 30px;
        position: absolute;
        top: 200px;
        left: 150px;
        background: red;
        border-radius: 3px;
    }
    
    </style>
</head>

<body>
    <header class="header">
        <div class="logo"></div>
        <ul class="action-bar">
            <li>文件</li>
            <li>编辑</li>
            <li>选择</li>
            <li>工具</li>
            <li>帮助</li>
        </ul>
    </header>
    <div class="container">
        <div class="navigation-bar">
            <div class="navigation-head">图层</div>
            <div class="layer-list" id="layerList"></div>
        </div>
        <div class="canvas" id="canvasArea">
            <div class="screen w414-h736" id="screenArea" al-type="Screen">
            </div>
            <div class="scale-bar">
                <button class="scale-small" id="scaleSmall">-</button>
                <span class="scale-status" id="scaleStatus">1.0</span>
                <button class="scale-large" id="scaleLarge">+</button>
            </div>
        </div>
        <div class="tools-bar">
            <div class="tools-module">
                <div class="module-symbol module-lable" al-name="module-symbol" al-type="Lable"></div>
                <div class="module-symbol module-image" al-name="module-symbol" al-type="Image"></div>
                <div class="module-symbol module-button" al-name="module-symbol" al-type="Button"></div>
                <div class="module-symbol module-view" al-name="module-symbol" al-type="View"></div>
            </div>
            <div class="attributes-editor" id="attributesEditor">
                
            </div>
        </div>
    </div>
    <footer class="footer"></footer>
</body>
<script>



(function () {
    var canvasArea = document.getElementById('canvasArea');
    var screenArea  = document.getElementById('screenArea');
    var scaleSmallBtn = document.getElementById("scaleSmall");
    var scaleLargeBtn = document.getElementById("scaleLarge");
    var scaleStatusSpan = document.getElementById("scaleStatus");
    var layerList = document.getElementById('layerList');
    var attributesEditor = document.getElementById('attributesEditor');

    var _MouseOver = "";                   //鼠标当前所在的元素
    var _MouseDownPosition = {x:0,y:0};    //鼠标按下的位置
    var _ScreenStartPosition = {x:50,y:50};//屏幕被选中时的初始位置
    var _ScreenSize = {w:414,h:736}        //当前屏幕的大小
    var _KeyDown = "";                     //按下的键值
    var _ScreenMoving = false;             //是否在拖动屏幕
    var _ScreenScale = 1;                  //缩放比例
    var _ModuleSelected = screenArea;      //被选中的元素
    var _ModuleMoving = false;             //是否在拖动元素
    var _ModuleStartPosition = {x:0,y:0}   //选中元素的时的位置
    var _ShowAllModule = false;            //是否裁剪
    var _LastId = 0;                       //当前最大id
    var _ModuleEnableStyles = {
        "Screen":{
            "Height" : "height"
        },
        "Lable":{
            "Width" : "width",
            "Height" : "height",
            "Left" : "left",
            "Top" : "top",
            "Background" : "background"
        },
        "Button":{
            "Width" : "width",
            "Height" : "height",
            "Left" : "left",
            "Top" : "top",
            "Background" : "background",
            "Border Width" : "border-width"
        },
        "Image" : {
            "Width" : "width",
            "Height" : "height",
            "Left" : "left",
            "Top" : "top",
            "Background" : "background",
            "Border Width" : "border-width",
            "Src" : "src"
        },
        "View":{
            "Width" : "width",
            "Height" : "height",
            "Left" : "left",
            "Top" : "top",
            "Background" : "background",
            "Border Width" : "border-width"
        }
    };
    var _Modulelists = {};


    
    initEditor();

    document.onmouseover = function (event) {
        var e = event || window.event || arguments.callee.caller.arguments[0];
        _MouseOver = e.target;
    }
    document.onmousemove =function (event) {
        var e = event || window.event || arguments.callee.caller.arguments[0];

        if (_KeyDown == 32 && _ScreenMoving) {

            screenArea.style.left = ((e.pageX - _MouseDownPosition.x)/_ScreenScale  + _ScreenStartPosition.x) + "px";
            screenArea.style.top = ((e.pageY - _MouseDownPosition.y)/_ScreenScale  + _ScreenStartPosition.y) + "px";
            // updateEditor();
        }else if(_ModuleMoving){
            _ModuleSelected.style.left = ((e.pageX - _MouseDownPosition.x)/_ScreenScale  + _ModuleStartPosition.x) + "px";
            _ModuleSelected.style.top = ((e.pageY - _MouseDownPosition.y)/_ScreenScale  + _ModuleStartPosition.y) + "px";
            
        }
        updateEditor();
    }
    document.onmousedown = function (event) {
        var e = event || window.event || arguments.callee.caller.arguments[0];
        _MouseDownPosition.x = e.pageX;
        _MouseDownPosition.y = e.pageY;

        if (isChildOfScreen(e.target) && _KeyDown == 32) {
            _ScreenMoving = true;
            _ScreenStartPosition.x =  parseFloat(window.getComputedStyle(screenArea).left) || 50;
            _ScreenStartPosition.y = parseFloat(window.getComputedStyle(screenArea).top) || 50;
            _ModuleSelected = screenArea;
            showSelected();

        }else if (e.target == scaleSmallBtn) {
            scaleSmallBtn.blur()
            scaleStatusSpan.textContent = 
                  screenArea.style.zoom = (_ScreenScale = (parseFloat(scaleStatusSpan.textContent) - 0.1).toFixed(1))+ "";

        }else if (e.target == scaleLargeBtn) {
            scaleLargeBtn.blur()
            scaleStatusSpan.textContent = 
                  screenArea.style.zoom = (_ScreenScale = (parseFloat(scaleStatusSpan.textContent) + 0.1).toFixed(1))+ "";
           
        }else if(e.target == canvasArea || e.target.parentNode == canvasArea){
            _ModuleSelected = screenArea;
            showSelected();
            // showEditor("Screen");
        }else if (e.target.getAttribute("al-name") == "module-symbol") {
            var type = e.target.getAttribute("al-type");
            var currentId  = getCurrentId();
            var newObject = createNewObject (currentId, type);
            var newLayer = createNewLayer (currentId, type);
            screenArea.appendChild(newObject);
            layerList.appendChild(newLayer);
            _ModuleSelected = newObject;
            showSelected();

        }else if (e.target.getAttribute("al-name") == "module") {
            _ModuleSelected = e.target;
            showSelected();
            _ModuleMoving = true;
            _ModuleStartPosition.x =  parseFloat(window.getComputedStyle(_ModuleSelected).left) || 0;
            _ModuleStartPosition.y = parseFloat(window.getComputedStyle(_ModuleSelected).top) || 0;
            
        }else if(e.target.getAttribute("al-name") == "layer"){
            var idStr = "M-" + e.target.getAttribute("al-id");
            _ModuleSelected = document.getElementById(idStr);
            showSelected();
        }
        
        updateLayer();
        showEditor();
    }
    document.onmouseup = function (event) {
        var e = event || window.event || arguments.callee.caller.arguments[0];

        if(_ModuleMoving && !isInScreen(_ModuleSelected)){
            var choice = confirm("要删除该元素吗?");
            if (choice) {
                var connectId = "L" + _ModuleSelected.id.substring(1);
                var connectLayer = document.getElementById(connectId);
                connectLayer.parentNode.removeChild(connectLayer);
                _ModuleSelected.parentNode.removeChild(_ModuleSelected);
                _ModuleSelected = "";
            }else{
                _ModuleSelected.style.left = _ModuleStartPosition.x + "px";
                _ModuleSelected.style.top = _ModuleStartPosition.y + "px";
            }
        }
        _ScreenMoving = false;
        _ModuleMoving = false;
    }
    document.onkeydown = function (event) {
        var e = event || window.event || arguments.callee.caller.arguments[0];
        _KeyDown = e.keyCode;

        if ( isChildOfScreen(_MouseOver) && e.keyCode == 32) {
            screenArea.style.cursor = "move";
        } else if(e.keyCode == 86){
            if (_ShowAllModule) {
                screenArea.style.overflow = "hidden";
                _ShowAllModule = false
            }else{
                screenArea.style.overflow = ""
                _ShowAllModule = true;
            }
        }
    }

    document.onkeyup = function (event) {
        var e = event || window.event || arguments.callee.caller.arguments[0];
        _KeyDown = "";
        if (e.keyCode == 32) {
            screenArea.style.cursor = "auto"
        }
    }

    function isChildOfScreen (obj){

        if(obj == screenArea || obj.parentNode == screenArea){
            return true;
        }
        return false;
    }

    function isInScreen (obj) {
        var objStatus = {
            x : parseFloat(window.getComputedStyle(obj).left) || 0,
            y : parseFloat(window.getComputedStyle(obj).top) || 0,
            w : parseFloat(window.getComputedStyle(obj).width) || 50,
            h : parseFloat(window.getComputedStyle(obj).height) || 50,
        };
        
        if(objStatus.x + objStatus.w <= 0 || objStatus.y + objStatus.h <= 0 || objStatus.x > _ScreenSize.w || objStatus.y > _ScreenSize.h){
            return false;
        }else{
            return true;
        }
        
    }
    function createNewObject (currentId, type) {
        console.log("createNewObject")
        var newObject = document.createElement("div");
        newObject.className = "module module-" + type.toLowerCase();
        newObject.id = "M-" + currentId;
        newObject.style.left = "0px";
        newObject.style.top = "0px";
        newObject.setAttribute("al-id",currentId);
        newObject.setAttribute("al-type", type);
        newObject.setAttribute("al-name","module")
        return newObject;
    }

    function createNewLayer (currentId, type) {
        var newLayer = document.createElement("div");
        newLayer.className ="layer-item";
        newLayer.id  = "L-" + currentId;
        newLayer.setAttribute("al-id", currentId);
        newLayer.setAttribute("al-name", "layer");
        newLayer.innerText = type + "-" + currentId;
        return newLayer;
    }

    function getCurrentId () {
        return ++_LastId;
    }

    function initEditor () {
        var styleList ={}
        for (type in _ModuleEnableStyles ){
            styleList = _ModuleEnableStyles[type];
            var element = document.createElement("div");
            for ( key in styleList) {
                htmlStr = '<div class="attribute-warp">'+ localize(key) + ':</div>';
                element.innerHTML += htmlStr;
                var inputElement = document.createElement('input');
                inputElement.setAttribute('onchange','changeAttributes(\'' + styleList[key]+'\')');
                inputElement.setAttribute('al-style', styleList[key]);

                element.lastChild.appendChild(inputElement);
            };
            _Modulelists[type] = element;
        }
        showEditor("Screen")
    }

    function showEditor () {
        var type = _ModuleSelected.getAttribute("al-type")
        console.log(type);
        attributesEditor.innerHTML = "";
        if (!type) {
            return;
        };
        attributesEditor.appendChild(_Modulelists[type]);
        updateEditor();
    }

    function updateLayer () {
        try{
            var classNameStr =  layerList.getElementsByClassName('layer-selected')[0].className;
            console.log(classNameStr.replace("layer-selected", ""))
            layerList.getElementsByClassName('layer-selected')[0].className = classNameStr.replace("layer-selected", "")
        }catch(e){}
        
        var idStr ="L-" + _ModuleSelected.getAttribute("al-id");
        try{
            document.getElementById(idStr).className += " layer-selected";
        }catch(e){}
        
    }

    function updateEditor () {
        var inputElements = attributesEditor.getElementsByTagName('input');
        for (var i = 0; i < inputElements.length; i++) {
            inputElements[i].value = window.getComputedStyle(_ModuleSelected)[inputElements[i].getAttribute("al-style")];
        };
    }


    function showSelected () {
        var originalboxShadow = window.getComputedStyle(_ModuleSelected).boxShadow;
        _ModuleSelected.style.boxShadow = "red 1px 1px 5px 3px";
        setTimeout(function () {
            _ModuleSelected.style.boxShadow = originalboxShadow;
            updateEditor();
        },100);
    }
    window.changeAttributes = function(styleStr) {
    var e = event || window.event;
        _ModuleSelected.style[styleStr] = e.target.value;
        if (_ModuleSelected == screenArea) {
            switch(styleStr){
                case "width" : _ScreenSize.w = parseFloat(e.target.value);break;
                case "height" : _ScreenSize.h = parseFloat(e.target.value);break;
                default : break;
            }
        };
    }

    function localize (str) {
        return str;
    }
})();
</script>

</html>
